{% extends "base.html" %}

{% block title %}M4Brew â€¢ Settings{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='settings.css') }}">
{% endblock %}

{% block content %}
<div class="card card--settings">
  <form method="post" action="/settings" id="settingsForm">
    <div class="stack">

      <div class="setting-row">
        <span class="label-pill"><strong>SELECT:</strong>&nbsp;Source folder</span>
        <input
          class="field"
          id="root_folder"
          type="text"
          name="root_folder"
          placeholder="/mnt/remotes/.../Audiobooks"
          value="{{ settings.get('root_folder','') if settings else '' }}"
        >
      </div>

      <div class="setting-row">
        <span class="label-pill"><strong>SELECT:</strong>&nbsp;Audio tracks</span>
        <select class="field" id="audio_mode" name="audio_mode">
          {% set am = (settings.get("audio_mode") if settings else "match") %}
          <option value="match" {% if am == "match" %}selected{% endif %}>match</option>
          <option value="mono" {% if am == "mono" %}selected{% endif %}>mono</option>
          <option value="stereo" {% if am == "stereo" %}selected{% endif %}>stereo</option>
        </select>
      </div>

      <div class="setting-row">
        <span class="label-pill"><strong>SELECT:</strong>&nbsp;Bitrate (kbps)</span>
        {% set br = (settings.get("bitrate", 96) if settings else 96) %}
        <select class="field" id="bitrate" name="bitrate">
          {% for v in [32,48,64,80,96,112,128,160,192,224,256,320] %}
            <option value="{{ v }}" {% if br == v %}selected{% endif %}>{{ v }}</option>
          {% endfor %}
        </select>
      </div>

    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-save (no save button / no "saved" pill)
  const form = document.getElementById("settingsForm");
  let t = null;

  const rootInput = document.getElementById("root_folder");
  const initialRoot = rootInput ? (rootInput.value || "") : "";
  let rootDirty = false;

  function autosave() {
    if (t) clearTimeout(t);
    t = setTimeout(async () => {
      try {
        const fd = new FormData(form);
        await fetch("/settings", {
          method: "POST",
          body: fd,
          headers: {
            "X-M4Brew-Autosave": "1",
            "X-M4Brew-Root-Dirty": rootDirty ? "1" : "0"
          }
        });
      } catch (e) {}
    }, 250);
  }

  if (rootInput) {
    rootInput.addEventListener("input", () => {
      rootDirty = (rootInput.value || "") !== initialRoot;
    });
  }

  form.addEventListener("input", autosave);
  form.addEventListener("change", autosave);
</script>
{% endblock %}
