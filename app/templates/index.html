{# 
GUARD TEMPLATE-SCOPE
This template EXTENDS base.html.
Common layout, <head>, <body>, and footer live in base.html.

If I'm looking for:
- global script blocks
- page lifecycle behaviour (scroll, persistence, etc.)
- shared assets or structure

STOP here and check base.html first.
Do NOT assume this file is standalone.
#}

{% extends "base.html" %}
{% block title %}M4Brew • Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}?v=1.2.3">
{% endblock %}

{% block content %}
<div class="card card--tasks">
  <div class="task-stack">

    <!-- SELECT / SETTINGS (embedded) -->
    <form method="post" action="/settings" id="settingsForm">
      <div class="stack">

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-source" role="button" tabindex="0" aria-label="More info: Source folder">
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Source folder</span>
          </div>

          <input
            class="field"
            id="root_folder"
            type="text"
            name="root_folder"
            placeholder="/mnt/remotes/.../Audiobooks"
            value="{{ settings.get('root_folder','') if settings else '' }}"
          >
        </div>

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-audio" role="button" tabindex="0" aria-label="More info: Audio tracks">
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Audio tracks</span>
          </div>

          <select class="field" id="audio_mode" name="audio_mode">
            {% set am = (settings.get("audio_mode") if settings else "match") %}
            <option value="match" {% if am == "match" %}selected{% endif %}>match</option>
            <option value="mono" {% if am == "mono" %}selected{% endif %}>mono</option>
            <option value="stereo" {% if am == "stereo" %}selected{% endif %}>stereo</option>
          </select>
        </div>

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-bitrate" role="button" tabindex="0" aria-label="More info: Bitrate">
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Bitrate (kbps)</span>
          </div>

          {% set br = (settings.get("bitrate", 96) if settings else 96) %}
          <select class="field" id="bitrate" name="bitrate">
            {% for v in [32,48,64,80,96,112,128,160,192,224,256,320] %}
              <option value="{{ v }}" {% if br == v %}selected{% endif %}>{{ v }}</option>
            {% endfor %}
          </select>
        </div>

      </div>
    </form>

    <div class="section-divider"></div>

    <!-- STEPS -->
    <div class="steps-block">

      <!-- STEP 1 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-convert" role="button" tabindex="0" aria-label="More info: Step 1 Convert">
            <span class="step-strong">STEP 1:</span>&nbsp;<span class="step-rest">Convert to m4b</span>
          </div>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-1" type="submit">Run</button>
          </form>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-rename" role="button" tabindex="0" aria-label="More info: Step 2 Rename">
            <span class="step-strong">STEP 2:</span>&nbsp;<span class="step-rest">Rename books</span>
          </div>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-2" type="submit">Run</button>
          </form>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-delete" role="button" tabindex="0" aria-label="More info: Step 3 Delete">
            <span class="step-strong">STEP 3:</span>&nbsp;<span class="step-rest">Remove backups</span>
          </div>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-3" type="submit">Run</button>
          </form>
        </div>
      </div>

    </div>

    <div class="section-divider"></div>

    <!-- STATUS + LIVE -->
    <div class="status-wrap">
      <div class="status-top" id="statusTop">
        <div class="status-pill status-pill--outlined" id="statusPill">Ready</div>
        <button class="btn live-btn is-off" id="liveBtn" type="button">Live output: OFF</button>

        <form method="post" action="/job/cancel" id="cancelForm" class="cancel-form" style="display:none;">
          <button class="btn danger" type="submit" id="cancelBtn">Cancel</button>
        </form>
      </div>

      <div id="liveWrap" class="live-wrap" style="display:none;">
        <div class="live-panel" id="livePanel" aria-live="polite">
          <div class="live-row"><div class="live-k">Task</div><div class="live-v" id="lvTask">—</div></div>
          <div class="live-row"><div class="live-k">Book</div><div class="live-v" id="lvBook">—</div></div>
          <div class="live-row"><div class="live-k">Progress</div><div class="live-v" id="lvProgress">—</div></div>
          <div class="live-row"><div class="live-k">Runtime</div><div class="live-v" id="lvRuntime">—</div></div>
          <div class="live-row"><div class="live-k">Audio</div><div class="live-v" id="lvAudio">—</div></div>
          <div class="live-row"><div class="live-k">Stage</div><div class="live-v" id="lvStage">—</div></div>
          <div class="live-row"><div class="live-k">Warnings</div><div class="live-v" id="lvWarn">—</div></div>
          <div class="live-row"><div class="live-k">Errors</div><div class="live-v" id="lvErr">—</div></div>

          <div class="live-actions">
            <a class="btn" id="historyLink" href="/history">View full logs</a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>


  <p class="donate-line">
    <span class="muted">If you enjoy using M4Brew, please consider </span>
    <a href="https://buymeacoffee.com/YOURNAME" target="_blank" rel="noopener">buying me a coffee ☕</a>
  </p>

<!-- HELP MODAL (Tasks page only) -->
<div class="help-overlay" id="helpOverlay" aria-hidden="true">
  <div class="help-modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpBody">
    <div class="help-head">
      <div class="help-title" id="helpTitle">Help</div>
      <button class="help-x" id="helpCloseBtn" type="button" aria-label="Close">×</button>
    </div>
    <div class="help-body" id="helpBody"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='tasks.js') }}?v=1.2.3"></script>
{% endblock %}
