{% extends "base.html" %}

{% block title %}m4brew â€¢ Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block content %}
<div class="card">
  <div class="task-stack">

    <!-- Step 1 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn w-test" type="submit">Test run</button>
        </form>

        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn w-step" type="submit">step 1: convert to m4b</button>
        </form>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn w-test" type="submit">Test run</button>
        </form>

        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn w-step" type="submit">step 2: rename books</button>
        </form>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn w-test" type="submit">Test run</button>
        </form>

        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn w-step" type="submit">step 3: remove backups</button>
        </form>
      </div>
    </div>

    <!-- Status -->
    <div class="status-wrap">
      <div class="status-top center">

        <div id="statusPill" class="status-pill">
          <span id="statusDot" class="status-dot dot-idle"></span>
          <span id="statusText">idle</span>
        </div>

        <button id="liveBtn" class="btn purple" type="button">Live output: OFF</button>
      </div>

      <div id="logWrap" style="display:none;">
        <pre id="logBox" class="mono"></pre>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const logWrap = document.getElementById("logWrap");
  const logBox = document.getElementById("logBox");
  const liveBtn = document.getElementById("liveBtn");

  const LIVE_KEY = "m4brew_live_output";
  let liveOn = (localStorage.getItem(LIVE_KEY) || "off") === "on";

  function setLiveLabel(){
    liveBtn.textContent = liveOn ? "Live output: ON" : "Live output: OFF";
  }

  function applyLive(){
    if (liveOn) {
      logWrap.style.display = "";
      liveBtn.classList.add("primary");
    } else {
      logWrap.style.display = "none";
      liveBtn.classList.remove("primary");
    }
    setLiveLabel();
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem(LIVE_KEY, liveOn ? "on" : "off");
    applyLive();
  });

  async function tick(){
    try {
      const r = await fetch("/api/job", { cache: "no-store" });
      const job = await r.json();
      statusText.textContent = job.status || "idle";
      if (liveOn) {
        const t = await fetch("/job/output", { cache: "no-store" });
        logBox.textContent = await t.text();
      }
    } catch {}
    setTimeout(tick, 1000);
  }

  applyLive();
  tick();
</script>
{% endblock %}
