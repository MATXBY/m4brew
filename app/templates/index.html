{% extends "base.html" %}

{% block title %}m4brew â€¢ Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block content %}
  <div class="card">
    <div class="task-stack">

      <!-- Step 1 -->
      <div class="task-row">
        <div class="task-group">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="false">
            <button class="step-pill step-btn" type="submit">step 1: convert to m4b</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test run</button>
          </form>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="task-row">
        <div class="task-group">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="false">
            <button class="step-pill step-btn" type="submit">step 2: rename books</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test run</button>
          </form>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="task-row">
        <div class="task-group">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="false">
            <button class="step-pill step-btn" type="submit">step 3: remove backups</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test run</button>
          </form>
        </div>
      </div>

      <!-- Status / Output -->
      <div class="status-wrap">
        <div class="status-top">
          <div id="statusPill" class="status-pill">
            <span id="statusDot" class="status-dot dot-idle"></span>
            <span id="statusText">idle</span>
          </div>

          <div class="status-actions">
            <button id="liveBtn" class="btn" type="button">Live output</button>
            <form method="post" action="/job/clear" style="margin:0;">
              <button class="btn" type="submit">Clear</button>
            </form>
          </div>
        </div>

        <div id="logWrap" style="display:none;">
          <pre id="logBox" class="mono"></pre>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const logWrap = document.getElementById("logWrap");
  const logBox = document.getElementById("logBox");
  const liveBtn = document.getElementById("liveBtn");

  const LIVE_KEY = "m4brew_live_output";
  let liveOn = (localStorage.getItem(LIVE_KEY) || "off") === "on";

  function setDot(state) {
    statusDot.classList.remove("dot-idle","dot-running","dot-finished","dot-failed");
    statusDot.classList.add(state);
  }

  function setStatus(label, state) {
    statusText.textContent = label;
    setDot(state);
  }

  function renderJob(job) {
    if (!job || job.status === "none") { setStatus("idle", "dot-idle"); return; }

    const cur = Number(job.current || 0);
    const tot = Number(job.total || 0);
    const frac = tot > 0 ? `${cur}/${tot}` : "0/0";

    if (job.status === "running") { setStatus(`running ${frac}`, "dot-running"); return; }
    if (job.status === "finished") {
      const doneFrac = tot > 0 ? `${Math.max(cur, tot)}/${tot}` : frac;
      setStatus(`finished ${doneFrac}`, "dot-finished");
      return;
    }
    setStatus(`failed ${frac}`, "dot-failed");
  }

  async function fetchJob() {
    const r = await fetch("/api/job", { cache: "no-store" });
    return await r.json();
  }

  async function fetchLog() {
    const r = await fetch("/job/output", { cache: "no-store" });
    return await r.text();
  }

  function applyLiveBtn() {
    if (liveOn) {
      liveBtn.classList.add("primary");
      logWrap.style.display = "";
    } else {
      liveBtn.classList.remove("primary");
      logWrap.style.display = "none";
    }
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem(LIVE_KEY, liveOn ? "on" : "off");
    applyLiveBtn();
  });

  async function tick() {
    try {
      const job = await fetchJob();
      renderJob(job);
      if (liveOn) logBox.textContent = await fetchLog();
    } catch (e) {}
    setTimeout(tick, 1000);
  }

  applyLiveBtn();
  tick();
</script>
{% endblock %}
