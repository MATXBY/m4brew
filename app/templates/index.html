{% extends "base.html" %}
{% block title %}m4brew â€¢ Tasks{% endblock %}

{% block extra_head %}
<style>
  .task-stack{ display:grid; gap:14px; padding: 6px; }

  .task-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap: 14px;
    align-items:center;
    padding: 16px;
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
  }

  .task-actions{ display:flex; gap:10px; align-items:center; }

  /* Make the step pill a real clickable "Start" button WITHOUT browser default styling */
  .step-btn{
    width: var(--label-w);
    appearance: none;
    -webkit-appearance: none;
    border: 1px solid rgba(124,92,255,.32);
    background: rgba(124,92,255,.18);
    color: rgba(233,237,243,.92);
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    border-radius: 999px;

    height: var(--pill-h);
    padding: 0 var(--pill-pad-x);

    display: inline-flex;
    align-items: center;
    justify-content: center;

    font: inherit;
    font-weight: 650;
    letter-spacing: .2px;
    cursor: pointer;
    user-select: none;
    text-decoration: none;
  }

  .step-btn:hover{ transform: translateY(-1px); }
  .step-btn:active{ transform: translateY(0px); }

  .status-wrap{
    margin-top: 14px;
    padding: 16px;
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
  }

  .status-top{
    display:flex;
    justify-content:space-between;
    gap: 14px;
    align-items:center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .status-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height: var(--pill-h);
    padding: 0 var(--pill-pad-x);
    border-radius: 999px;
    font-weight: 650;
    letter-spacing: .2px;
    background: rgba(255,255,255,.05);
    border: 1px solid var(--border);
    color: var(--text);
    gap: 10px;
  }

  .status-dot{
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: rgba(233,237,243,.35);
  }
  .dot-idle { background: rgba(233,237,243,.35); }
  .dot-running { background: #f59e0b; }
  .dot-finished { background: #22c55e; }
  .dot-failed { background: #ef4444; }

  /* stop long lines stretching layout */
  pre{
    max-width: 100%;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    word-break: break-word;
    overflow-x: hidden;
    max-height: 45vh;
    overflow-y: auto;
  }
</style>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="task-stack">

      <!-- Step 1 -->
      <div class="task-row">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-btn" type="submit">step 1: convert to m4b</button>
        </form>

        <div class="task-actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test</button>
          </form>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="task-row">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-btn" type="submit">step 2: rename books</button>
        </form>

        <div class="task-actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test</button>
          </form>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="task-row">
        <form method="post" action="/" style="margin:0;">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-btn" type="submit">step 3: remove backups</button>
        </form>

        <div class="task-actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn" type="submit">Test</button>
          </form>
        </div>
      </div>

      <!-- Status / Output -->
      <div class="status-wrap">
        <div class="status-top">
          <div id="statusPill" class="status-pill">
            <span id="statusDot" class="status-dot dot-idle"></span>
            <span id="statusText">idle</span>
          </div>

          <div class="task-actions">
            <button id="liveBtn" class="btn" type="button">Live output</button>

            <form method="post" action="/job/clear" style="margin:0;">
              <button class="btn" type="submit">Clear</button>
            </form>
          </div>
        </div>

        <div id="logWrap" style="display:none;">
          <pre id="logBox" class="mono"></pre>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const logWrap = document.getElementById("logWrap");
  const logBox = document.getElementById("logBox");
  const liveBtn = document.getElementById("liveBtn");

  const LIVE_KEY = "m4brew_live_output";
  let liveOn = (localStorage.getItem(LIVE_KEY) || "off") === "on";

  function setDot(state) {
    statusDot.classList.remove("dot-idle","dot-running","dot-finished","dot-failed");
    statusDot.classList.add(state);
  }

  function setStatus(label, state) {
    statusText.textContent = label;
    setDot(state);
  }

  function renderJob(job) {
    if (!job || job.status === "none") {
      setStatus("idle", "dot-idle");
      return;
    }

    const cur = Number(job.current || 0);
    const tot = Number(job.total || 0);
    const frac = tot > 0 ? `${cur}/${tot}` : "0/0";

    if (job.status === "running") {
      setStatus(`running ${frac}`, "dot-running");
      return;
    }

    if (job.status === "finished") {
      const done = tot > 0 ? `${Math.max(cur, tot)}/${tot}` : frac;
      setStatus(`finished ${done}`, "dot-finished");
      return;
    }

    setStatus(`failed ${frac}`, "dot-failed");
  }

  async function fetchJob() {
    const r = await fetch("/api/job", { cache: "no-store" });
    return await r.json();
  }

  async function fetchLog() {
    const r = await fetch("/job/output", { cache: "no-store" });
    return await r.text();
  }

  function applyLiveBtn() {
    if (liveOn) {
      liveBtn.classList.add("primary");
      logWrap.style.display = "";
    } else {
      liveBtn.classList.remove("primary");
      logWrap.style.display = "none";
    }
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem(LIVE_KEY, liveOn ? "on" : "off");
    applyLiveBtn();
  });

  async function tick() {
    try {
      const job = await fetchJob();
      renderJob(job);
      if (liveOn) logBox.textContent = await fetchLog();
    } catch (e) {}
  }

  applyLiveBtn();
  tick();
  setInterval(tick, 1000);
</script>
{% endblock %}
