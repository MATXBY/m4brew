{% extends "base.html" %}
{% set active_page = "tasks" %}
{% block title %}m4brew — Tasks{% endblock %}

{% block content %}
  <!-- Job status card -->
  <div class="card" id="jobCard" style="display:none; margin-bottom:16px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:10px;">
        <strong>Job</strong>
        <span class="pill" id="jobStatusPill">—</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <a class="btn" href="/job/output" target="_blank" rel="noreferrer">Live output</a>
        <form method="post" action="/job/clear" style="margin:0;">
          <button class="btn" type="submit" id="clearJobBtn" disabled>Clear job</button>
        </form>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      <span class="mono">mode</span>: <span id="jobMode">—</span> •
      <span class="mono">dry_run</span>: <span id="jobDryRun">—</span> •
      <span class="mono">started</span>: <span id="jobStarted">—</span>
    </div>

    <div style="margin-top:12px;">
      <div><strong>Progress:</strong> <span id="jobProgress">—</span></div>
      <div class="muted"><span class="mono" id="jobBook">—</span></div>
      <div class="muted"><span class="mono" id="jobPath">—</span></div>
    </div>
  </div>

  <!-- Task form -->
  <div class="card">
    <form id="runForm" method="post" action="/">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label for="mode">Mode</label>
          <select id="mode" name="mode">
            <option value="convert" {% if (settings.get("mode") or "convert") == "convert" %}selected{% endif %}>convert (create .m4b + backup sources)</option>
            <option value="correct" {% if (settings.get("mode") or "") == "correct" %}selected{% endif %}>correct (rename .m4b to match folder)</option>
            <option value="cleanup" {% if (settings.get("mode") or "") == "cleanup" %}selected{% endif %}>cleanup (delete _backup_files)</option>
          </select>
        </div>

        <div>
          <label for="dry_run">Dry run</label>
          <select id="dry_run" name="dry_run">
            {% set dr = (settings.get("dry_run") if settings else "true") %}
            <option value="true" {% if (dr|string).lower() == "true" %}selected{% endif %}>true (simulate only)</option>
            <option value="false" {% if (dr|string).lower() == "false" %}selected{% endif %}>false (make changes)</option>
          </select>
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="root_folder">Root folder</label>
          <input id="root_folder" type="text" name="root_folder"
                 placeholder="/mnt/remotes/.../Audiobooks"
                 value="{{ settings.get('root_folder','') if settings else '' }}">
        </div>

        <div>
          <label for="audio_mode">Audio mode</label>
          <select id="audio_mode" name="audio_mode">
            {% set am = (settings.get("audio_mode") if settings else "match") %}
            <option value="match" {% if am == "match" %}selected{% endif %}>match (detect mono/stereo)</option>
            <option value="mono" {% if am == "mono" %}selected{% endif %}>mono</option>
            <option value="stereo" {% if am == "stereo" %}selected{% endif %}>stereo</option>
          </select>
        </div>

        <div>
          <label for="bitrate">Bitrate (kbps)</label>
          <input id="bitrate" type="number" name="bitrate" min="32" max="320" step="1"
                 value="{{ settings.get('bitrate', 64) if settings else 64 }}">
        </div>
      </div>

      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:14px;">
        <button id="runBtn" class="btn primary" type="submit">Run</button>
        <span class="muted" id="hint">Jobs run in the background — refresh is safe.</span>
      </div>
    </form>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const jobCard = document.getElementById("jobCard");
  const jobStatusPill = document.getElementById("jobStatusPill");
  const clearJobBtn = document.getElementById("clearJobBtn");

  const jobMode = document.getElementById("jobMode");
  const jobDryRun = document.getElementById("jobDryRun");
  const jobStarted = document.getElementById("jobStarted");
  const jobProgress = document.getElementById("jobProgress");
  const jobBook = document.getElementById("jobBook");
  const jobPath = document.getElementById("jobPath");

  function setPill(status, mode, total) {
    const safe = (status || "unknown").toLowerCase();
    const m = (mode || "").toLowerCase();

    if (safe === "running") {
      jobStatusPill.className = "pill";
      jobStatusPill.textContent = "⏳ running";
      clearJobBtn.disabled = true;
      return;
    }
    if (safe === "finished") {
      jobStatusPill.className = "pill";
      if (typeof total === "number" && total === 0) {
        if (m === "cleanup") jobStatusPill.textContent = "✨ nothing to delete";
        else if (m === "correct") jobStatusPill.textContent = "✨ all names correct";
        else jobStatusPill.textContent = "✨ nothing to convert";
      } else {
        jobStatusPill.textContent = "✅ finished";
      }
      clearJobBtn.disabled = false;
      return;
    }
    if (safe === "failed") {
      jobStatusPill.className = "pill";
      jobStatusPill.textContent = "❌ failed";
      clearJobBtn.disabled = false;
      return;
    }
    jobStatusPill.className = "pill";
    jobStatusPill.textContent = safe;
    clearJobBtn.disabled = false;
  }

  async function pollJob() {
    try {
      const r = await fetch("/api/job", { cache: "no-store" });
      const j = await r.json();

      if (!j || j.status === "none") {
        jobCard.style.display = "none";
        return;
      }

      jobCard.style.display = "block";

      const cur = (typeof j.current === "number") ? j.current : 0;
      const tot = (typeof j.total === "number") ? j.total : null;

      setPill(j.status || "unknown", j.mode || "", tot);

      jobMode.textContent = j.mode || "—";
      jobDryRun.textContent = (j.dry_run === true) ? "true" : (j.dry_run === false ? "false" : "—");
      jobStarted.textContent = j.started || "—";

      if (tot === 0 && j.status === "finished") {
        jobProgress.textContent = "—";
        jobBook.textContent = "—";
        jobPath.textContent = "—";
        return;
      }

      jobProgress.textContent = (tot && tot > 0) ? `${cur}/${tot}` : `${cur}/?`;

      jobBook.textContent = j.current_book ? `BOOK: ${j.current_book}` : "—";
      jobPath.textContent = j.current_path ? `PATH: ${j.current_path}` : "—";
    } catch (e) {
      // ignore polling errors
    }
  }

  pollJob();
  setInterval(pollJob, 2000);
</script>
{% endblock %}
