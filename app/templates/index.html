{% extends "base.html" %}
{% block title %}m4brew • Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}?v=1.0.9">
{% endblock %}

{% block content %}
<div class="card card--tasks">
  <div class="task-stack">

    <!-- SELECT / SETTINGS (embedded) -->
    <form method="post" action="/settings" id="settingsForm">
      <div class="stack">

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-source" role="button" tabindex="0" aria-label="More info: Source folder">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Source folder</span>
          </div>

          <input
            class="field"
            id="root_folder"
            type="text"
            name="root_folder"
            placeholder="/mnt/remotes/.../Audiobooks"
            value="{{ settings.get('root_folder','') if settings else '' }}"
          >
        </div>

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-audio" role="button" tabindex="0" aria-label="More info: Audio tracks">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Audio tracks</span>
          </div>

          <select class="field" id="audio_mode" name="audio_mode">
            {% set am = (settings.get("audio_mode") if settings else "match") %}
            <option value="match" {% if am == "match" %}selected{% endif %}>match</option>
            <option value="mono" {% if am == "mono" %}selected{% endif %}>mono</option>
            <option value="stereo" {% if am == "stereo" %}selected{% endif %}>stereo</option>
          </select>
        </div>

        <div class="setting-row">
          <div class="step-label is-select" data-help="select-bitrate" role="button" tabindex="0" aria-label="More info: Bitrate">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">SELECT:</span>&nbsp;<span class="step-rest">Bitrate (kbps)</span>
          </div>

          {% set br = (settings.get("bitrate", 96) if settings else 96) %}
          <select class="field" id="bitrate" name="bitrate">
            {% for v in [32,48,64,80,96,112,128,160,192,224,256,320] %}
              <option value="{{ v }}" {% if br == v %}selected{% endif %}>{{ v }}</option>
            {% endfor %}
          </select>
        </div>

      </div>
    </form>

    <div class="section-divider"></div>

    <!-- STEPS -->
    <div class="steps-block">

      <!-- STEP 1 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-convert" role="button" tabindex="0" aria-label="More info: Step 1 Convert">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">STEP 1:</span>&nbsp;<span class="step-rest">Convert to m4b</span>
          </div>

          <form method="post" action="/" class="help-test" data-help="step-convert-test">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-1" type="submit">Run</button>
          </form>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-rename" role="button" tabindex="0" aria-label="More info: Step 2 Rename">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">STEP 2:</span>&nbsp;<span class="step-rest">Rename books</span>
          </div>

          <form method="post" action="/" class="help-test" data-help="step-rename-test">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-2" type="submit">Run</button>
          </form>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="task-row">
        <div class="task-group">
          <div class="step-label" data-help="step-delete" role="button" tabindex="0" aria-label="More info: Step 3 Delete">
            <span class="pill-i" aria-hidden="true">i</span>
            <span class="step-strong">STEP 3:</span>&nbsp;<span class="step-rest">Remove backups</span>
          </div>

          <form method="post" action="/" class="help-test" data-help="step-delete-test">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="true">
            <button class="btn task-btn task-test" type="submit">Test</button>
          </form>

          <form method="post" action="/">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="false">
            <button class="btn task-btn task-run run-3" type="submit">Run</button>
          </form>
        </div>
      </div>

    </div>

    <div class="section-divider"></div>

    <!-- STATUS + LIVE -->
    <div class="status-wrap">
      <div class="status-top">
        <div class="status-pill status-pill--outlined" id="statusPill">Ready</div>

        <button class="btn live-btn" id="liveBtn" type="button">Live output: OFF</button>

        <form method="post" action="/job/cancel" id="cancelForm">
          <button class="btn danger" type="submit" id="cancelBtn" style="display:none;">Cancel</button>
        </form>
      </div>

      <div id="liveWrap" class="live-wrap" style="display:none;">
        <div class="live-panel" id="livePanel" aria-live="polite">
          <div class="live-row"><div class="live-k">Task</div><div class="live-v" id="lvTask">—</div></div>
          <div class="live-row"><div class="live-k">Book</div><div class="live-v" id="lvBook">—</div></div>
          <div class="live-row"><div class="live-k">Progress</div><div class="live-v" id="lvProgress">—</div></div>
          <div class="live-row"><div class="live-k">Runtime</div><div class="live-v" id="lvRuntime">—</div></div>
          <div class="live-row"><div class="live-k">Audio</div><div class="live-v" id="lvAudio">—</div></div>
          <div class="live-row"><div class="live-k">Stage</div><div class="live-v" id="lvStage">—</div></div>
          <div class="live-row"><div class="live-k">Warnings</div><div class="live-v" id="lvWarn">—</div></div>
          <div class="live-row"><div class="live-k">Errors</div><div class="live-v" id="lvErr">—</div></div>
        </div>

        <div class="live-actions">
          <a class="btn" id="historyLink" href="/history">View full log in History</a>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- HELP MODAL (Tasks page only) -->
<div class="help-overlay" id="helpOverlay" aria-hidden="true">
  <div class="help-modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpBody">
    <div class="help-head">
      <div class="help-title" id="helpTitle">Help</div>
      <button class="btn help-close" id="helpCloseBtn" type="button">Close</button>
    </div>
    <div class="help-body" id="helpBody"></div>
  </div>
</div>

<script>
(function(){
  // ---------- HELP COPY (from About page content / same wording style) ----------
  const HELP = {
    "select-source": {
      title: "Source folder",
      body: [
        "Point m4brew at your Audiobooks root folder.",
        "Your audiobooks should be organised like: author / book / audio files."
      ]
    },
    "select-audio": {
      title: "Audio tracks",
      body: [
        "Choose how audio should be handled:",
        "• match — keep what the source uses",
        "• mono — force mono",
        "• stereo — force stereo"
      ]
    },
    "select-bitrate": {
      title: "Bitrate (kbps)",
      body: [
        "Pick the output bitrate for conversions.",
        "Tip: 'match source' is coming soon."
      ]
    },

    "step-convert": {
      title: "STEP 1: Convert",
      body: [
        "Batch converts each of your audiobooks into a single chapterised M4B.",
        "This makes make importing books into media mangers much easier.",
        "TEST: shows how many books will be converted.",
        "RUN: begins the actual conversion process."
      ]
    },
    "step-convert-test": {
      title: "STEP 1: Convert (Test)",
      body: [
        "TEST: shows how many books will be converted."
      ]
    },

    "step-rename": {
      title: "STEP 2: Rename",
      body: [
        "Renames your new audiobooks for easier metadata matching.",
        "File naming is based on folder structure:",
        "author_name/book_title/files becomes the name: book - author.m4b"
      ]
    },
    "step-rename-test": {
      title: "STEP 2: Rename (Test)",
      body: [
        "TEST: shows how many books will be renamed."
      ]
    },

    "step-delete": {
      title: "STEP 3: Delete",
      body: [
        "NOTHING is lost after conversion. After conversion all the original files are stored safely in a new folder here: book folder/_backup_files",
        "However, If you want to reclaim disc space, this task batch deletes all the original file ‘backup’ folders in one go."
      ]
    },
    "step-delete-test": {
      title: "STEP 3: Delete (Test)",
      body: [
        "TEST: shows how many backup folders would be deleted."
      ]
    }
  };

  const overlay = document.getElementById("helpOverlay");
  const closeBtn = document.getElementById("helpCloseBtn");
  const bodyEl = document.getElementById("helpBody");
  const titleEl = document.getElementById("helpTitle");

  function openHelp(key){
    const h = HELP[key];
    if(!h) return;
    titleEl.textContent = h.title || "Help";
    bodyEl.innerHTML = (h.body || []).map(line => `<p>${escapeHtml(line)}</p>`).join("");
    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden", "false");
    closeBtn.focus();
  }

  function closeHelp(){
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden", "true");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  // click info pills (SELECT/STEP labels)
  document.addEventListener("click", (e) => {
    const t = e.target;

    // If clicking the "i" or anywhere on the step-label with data-help
    const label = t.closest && t.closest(".step-label[data-help]");
    if(label){
      openHelp(label.getAttribute("data-help"));
      return;
    }
  });

  // Test buttons: open help instead of submitting
  document.querySelectorAll("form.help-test").forEach(form => {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const key = form.getAttribute("data-help");
      openHelp(key);
    });
  });

  // Close behaviours
  closeBtn.addEventListener("click", closeHelp);

  overlay.addEventListener("click", (e) => {
    // only close if clicking the dim background, not the modal
    if(e.target === overlay) closeHelp();
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && overlay.classList.contains("open")) closeHelp();
  });

  // ---------- Existing Tasks JS (unchanged behaviour) ----------
  const statusPill = document.getElementById("statusPill");
  const liveBtn = document.getElementById("liveBtn");
  const liveWrap = document.getElementById("liveWrap");
  const cancelBtn = document.getElementById("cancelBtn");

  const lvTask = document.getElementById("lvTask");
  const lvBook = document.getElementById("lvBook");
  const lvProgress = document.getElementById("lvProgress");
  const lvRuntime = document.getElementById("lvRuntime");
  const lvAudio = document.getElementById("lvAudio");
  const lvStage = document.getElementById("lvStage");
  const lvWarn = document.getElementById("lvWarn");
  const lvErr = document.getElementById("lvErr");

  // Autosave settings
  const form = document.getElementById("settingsForm");
  let t = null;
  const rootInput = document.getElementById("root_folder");
  const initialRoot = rootInput ? (rootInput.value || "") : "";
  let rootDirty = false;

  function autosave() {
    if (!form) return;
    if (t) clearTimeout(t);
    t = setTimeout(async () => {
      try {
        const fd = new FormData(form);
        await fetch("/settings", {
          method: "POST",
          body: fd,
          headers: {
            "X-M4Brew-Autosave": "1",
            "X-M4Brew-Root-Dirty": rootDirty ? "1" : "0"
          }
        });
      } catch (e) {}
    }, 250);
  }

  if (rootInput) {
    rootInput.addEventListener("input", () => {
      rootDirty = (rootInput.value || "") !== initialRoot;
    });
  }
  if (form){
    form.addEventListener("input", autosave);
    form.addEventListener("change", autosave);
  }

  let liveOn = (localStorage.getItem("m4brew_live") === "1");

  function pad2(n){ n = Number(n||0); return (n < 10 ? "0" : "") + n; }
  function fmtRuntime(seconds){
    const s = Math.max(0, Number(seconds || 0));
    const hh = Math.floor(s / 3600);
    const mm = Math.floor((s % 3600) / 60);
    const ss = Math.floor(s % 60);
    return pad2(hh) + ":" + pad2(mm) + ":" + pad2(ss);
  }
  function runtimeFromStarted(startedIso){
    if(!startedIso) return null;
    const t0 = Date.parse(String(startedIso));
    if(!Number.isFinite(t0)) return null;
    return Math.floor((Date.now() - t0) / 1000);
  }
  function modeLabel(mode){
    const m = String(mode || "").toLowerCase();
    return (m === "convert") ? "Convert"
         : (m === "correct") ? "Rename"
         : (m === "cleanup") ? "Delete"
         : "Run";
  }
  function isDryRun(job){
    const s = (job && job.summary) ? job.summary : {};
    return (job && (job.dry_run === true || job.dry_run === "true")) ||
           (s && (s.dry_run === true || s.dry_run === "true"));
  }
  function setLiveUI(){
    liveBtn.textContent = "Live output: " + (liveOn ? "ON" : "OFF");
    liveBtn.classList.toggle("primary", liveOn);
    liveBtn.classList.toggle("is-off", !liveOn);
    liveWrap.style.display = liveOn ? "block" : "none";
  }
  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem("m4brew_live", liveOn ? "1" : "0");
    setLiveUI();
  });

  function statusTextForFinished(job){
    const s = (job && job.summary) ? job.summary : {};
    const mode = String(job && job.mode ? job.mode : "").toLowerCase();

    const noun = (mode === "convert") ? "convert"
               : (mode === "correct") ? "rename"
               : (mode === "cleanup") ? "delete"
               : "run";

    const past = (mode === "convert") ? "converted"
               : (mode === "correct") ? "renamed"
               : (mode === "cleanup") ? "deleted"
               : "done";

    const count = (mode === "convert") ? Number(s.created ?? 0)
                 : (mode === "correct") ? Number(s.renamed ?? 0)
                 : (mode === "cleanup") ? Number(s.deleted ?? 0)
                 : 0;

    const dry = isDryRun(job);

    if(count > 0){
      if(dry) return "Test: " + count + " to " + noun;
      return '<span style="color:#6ee7b7;font-weight:800;">✓&nbsp;</span>Done: ' + count + " " + past;
    }
    return "Nothing to " + noun;
  }

  function bookFromPath(p){
    const s = String(p || "");
    if(!s) return "—";
    const parts = s.split("/").filter(Boolean);
    if(parts.length < 2) return s;
    const book = parts[parts.length - 1];
    const author = parts[parts.length - 2];
    return author + " / " + book;
  }

  function updateLivePanel(job){
    if(!job || !job.status){
      lvTask.textContent = "—";
      lvBook.textContent = "—";
      lvProgress.textContent = "—";
      lvRuntime.textContent = "—";
      lvAudio.textContent = "—";
      lvStage.textContent = "—";
      lvWarn.textContent = "—";
      lvErr.textContent = "—";
      return;
    }

    const mode = String(job.mode || "").toLowerCase();
    const task = modeLabel(mode);
    const dry = isDryRun(job);
    const taskLine = task + " (" + (dry ? "Test" : "Run") + ")";

    const book = (job.current_path && String(job.current_path).trim())
      ? bookFromPath(job.current_path)
      : ((job.current_book && String(job.current_book).trim()) ? String(job.current_book) : "—");

    const total = Number(job.total || 0);
    const current = Number(job.current || 0);
    const progress = (total > 0) ? (current + " / " + total) : "—";

    let seconds = null;
    if (job.runtime_s != null) seconds = Number(job.runtime_s);
    else if (job.started) seconds = runtimeFromStarted(job.started);
    const rt = (seconds != null) ? fmtRuntime(seconds) : "—";

    const st = (job.status === "running")
      ? (mode === "convert" ? "Converting"
        : mode === "correct" ? "Renaming"
        : mode === "cleanup" ? "Deleting"
        : "Running")
      : (job.status === "finished" ? "Finished" : String(job.status));

    const settings = job.settings || {};
    const am = settings.audio_mode ? String(settings.audio_mode) : "—";
    const br = (settings.bitrate != null) ? String(settings.bitrate) + " kbps" : "—";
    const audio = (am !== "—" || br !== "—") ? (am + ", " + br) : "—";

    const sum = job.summary || {};
    const warnings = "0";
    const errors = String(Number(sum.failed || 0));

    lvTask.textContent = taskLine;
    lvBook.textContent = book;
    lvProgress.textContent = progress;
    lvRuntime.textContent = rt;
    lvAudio.textContent = audio;
    lvStage.textContent = st;
    lvWarn.textContent = warnings;
    lvErr.textContent = errors;
  }

  async function tick(){
    try{
      const r = await fetch("/api/job", {cache:"no-store"});
      const job = await r.json();

      const showCancel = (job && job.status === "running" && job.mode === "convert");
      cancelBtn.style.display = showCancel ? "inline-flex" : "none";

      if(!job || !job.status){
        statusPill.textContent = "Ready";
      }else if(job.status === "running"){
        if(job.total && job.total > 0){
          statusPill.textContent = `Running: ${job.current}/${job.total}`;
        }else{
          const mode = (job.mode || "").toLowerCase();
          statusPill.textContent =
            mode === "convert" ? "Converting…" :
            mode === "correct" ? "Renaming…" :
            mode === "cleanup" ? "Deleting…" : "Running…";
        }
      }else if(job.status === "finished"){
        statusPill.innerHTML = statusTextForFinished(job);
      }else{
        statusPill.textContent = String(job.status || "");
      }

      if(liveOn){
        updateLivePanel(job);
      }
    }catch(e){}
  }

  setLiveUI();
  tick();
  setInterval(tick, 1200);
})();
</script>
{% endblock %}
