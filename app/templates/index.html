{% extends "base.html" %}

{% block title %}m4brew â€¢ Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block content %}
<div class="card">
  <div class="task-stack">

    <!-- Step 1 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>


  <!-- Cancel (always visible; enabled only while running) -->
  <div id="cancelWrap" style="margin-top:12px;">
    <form method="post" action="/job/cancel" id="cancelForm" style="display:inline;">
      <button class="btn" type="submit" id="cancelBtn" disabled>Cancel</button>
    </form>
  </div>



        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 1: convert to m4b
          </button>
        </form>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 2: rename books
          </button>
        </form>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 3: remove backups
          </button>
        </form>
      </div>
    </div>

    <!-- Status -->
    <div class="status-wrap">
      <div class="status-top">

        <div id="statusPill" class="status-pill">
          <span id="statusDot" class="status-dot dot-idle"></span>
          <span id="statusText">idle</span>
        </div>

        <button id="liveBtn" class="btn" type="button">
          Live output: OFF
        </button>
      </div>

      <div id="logWrap" style="display:none;">
        <pre id="logBox" class="mono"></pre>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const logWrap = document.getElementById("logWrap");
  const logBox = document.getElementById("logBox");
  const liveBtn = document.getElementById("liveBtn");

  const LIVE_KEY = "m4brew_live_output";
  let liveOn = (localStorage.getItem(LIVE_KEY) || "off") === "on";

  function setLiveLabel(){
    liveBtn.textContent = liveOn ? "Live output: ON" : "Live output: OFF";
  }

  function applyLive(){
    if (liveOn) {
      logWrap.style.display = "";
      liveBtn.classList.add("primary");
    } else {
      logWrap.style.display = "none";
      liveBtn.classList.remove("primary");
    }
    setLiveLabel();
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem(LIVE_KEY, liveOn ? "on" : "off");
    applyLive();
  });

  async function tick(){
    try {
      const r = await fetch("/api/job", { cache: "no-store" });
      const job = await r.json();
      const mode = String(job.mode || "").toLowerCase();
      const total = Number(job.total || 0);
      const current = Math.min(Number(job.current || 0), (total || 0));

      const noun = (mode === "convert") ? "convert"
                 : (mode === "correct") ? "rename"
                 : (mode === "cleanup") ? "delete"
                 : "run";

      const verb = (mode === "convert") ? "Converting"
                 : (mode === "correct") ? "Renaming"
                 : (mode === "cleanup") ? "Deleting"
                 : "Running";

      let text = "idle";
      let dot = "dot-idle";

      if (job.status === "running") {
        if (total > 0) {
          text = verb + " " + current + "/" + total;
          dot = "dot-running";
        } else {
          text = "Nothing to " + noun;
          dot = "dot-ok";
        }
      } else if (job.status === "finished") {
        text = total > 0 ? ((job && job.dry_run) ? (total + " to " + noun) : ("Complete " + total + "/" + total)) : ("Nothing to " + noun);
        dot = "dot-ok";
      } else if (job.status === "failed") {
        text = "Failed";
        dot = "dot-bad";
      }

      statusText.textContent = text;
      statusDot.classList.remove("dot-idle","dot-running","dot-ok","dot-bad");
      statusDot.classList.add(dot);

        // Cancel button: enabled only while running
        const cancelBtn = document.getElementById("cancelBtn");
        if (cancelBtn) {
          const st = (job && job.status) ? job.status : "";
          if (st === "running") {
            cancelBtn.disabled = false;
            cancelBtn.textContent = "Cancel";
          } else if (st === "canceling") {
            cancelBtn.disabled = true;
            cancelBtn.textContent = "Canceling...";
          } else {
            cancelBtn.disabled = true;
            cancelBtn.textContent = "Cancel";
          }
        }


      if (liveOn) {
        const t = await fetch("/job/output", { cache: "no-store" });
        logBox.textContent = await t.text();
      }
    } catch {}
    setTimeout(tick, 1000);
  }

  applyLive();
  tick();
</script>
{% endblock %}

<script>
(function () {
