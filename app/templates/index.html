{% extends "base.html" %}
{% set active_page = "tasks" %}

{% block title %}m4brew • Tasks{% endblock %}

{% block content %}
  <div class="card" style="padding: 18px;">
    <!-- Steps -->
    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="stepRow">
        <div class="stepLabel">step 1: convert to m4b</div>

        <form method="post" action="/" style="margin:0; display:flex; gap:10px;">
          <input type="hidden" name="mode" value="convert">
          <button class="btn" type="submit" name="dry_run" value="true">Test</button>
          <button class="btn primary" type="submit" name="dry_run" value="false">Start</button>
        </form>
      </div>

      <div class="stepRow">
        <div class="stepLabel">step 2: rename books</div>

        <form method="post" action="/" style="margin:0; display:flex; gap:10px;">
          <input type="hidden" name="mode" value="correct">
          <button class="btn" type="submit" name="dry_run" value="true">Test</button>
          <button class="btn primary" type="submit" name="dry_run" value="false">Start</button>
        </form>
      </div>

      <div class="stepRow">
        <div class="stepLabel">step 3: remove backups</div>

        <form method="post" action="/" style="margin:0; display:flex; gap:10px;">
          <input type="hidden" name="mode" value="cleanup">
          <button class="btn" type="submit" name="dry_run" value="true">Test</button>
          <button class="btn primary" type="submit" name="dry_run" value="false">Start</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Output -->
  <div class="card" style="margin-top:16px; padding: 18px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;">
      <div style="font-weight: 700; font-size: 18px;">Output</div>

      <div style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
        <label style="display:flex; align-items:center; gap: 8px; margin:0; cursor:pointer;">
          <input id="liveToggle" type="checkbox" style="transform: translateY(1px);">
          <span class="muted">Live output</span>
        </label>

        <button class="btn danger" type="button" disabled title="Not wired up yet">Cancel</button>

        <form method="post" action="/job/clear" style="margin:0;">
          <button class="btn" type="submit" id="clearJobBtn" disabled>Clear</button>
        </form>
      </div>
    </div>

    <div style="margin-top: 14px;">
      <div class="muted" id="jobSummaryLine">Idle.</div>

      <div style="margin-top: 10px;">
        <div class="muted">
          <span class="mono">mode</span>: <span id="jobMode">—</span> •
          <span class="mono">dry_run</span>: <span id="jobDryRun">—</span> •
          <span class="mono">started</span>: <span id="jobStarted">—</span>
        </div>

        <div style="margin-top: 10px;">
          <div><strong>Progress</strong> <span id="jobProgress">—</span></div>
          <div class="muted"><span class="mono" id="jobBook">—</span></div>
          <div class="muted"><span class="mono" id="jobPath">—</span></div>
        </div>
      </div>

      <div id="liveBlock" style="margin-top: 14px; display:none;">
        <pre id="liveOutput" style="margin:0;"></pre>
      </div>
    </div>
  </div>

  <style>
    .stepRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(233,237,243,.10);
      background: rgba(0,0,0,.12);
    }
    .stepLabel{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(233,237,243,.10);
      background: rgba(0,0,0,.18);
      min-width: 260px;
    }
    @media (max-width: 720px){
      .stepRow{ flex-direction: column; align-items: stretch; }
      .stepLabel{ width: 100%; min-width: 0; }
      .stepRow form{ width: 100%; justify-content: flex-end; }
    }
  </style>
{% endblock %}

{% block extra_js %}
<script>
  const clearJobBtn = document.getElementById("clearJobBtn");
  const liveToggle = document.getElementById("liveToggle");
  const liveBlock = document.getElementById("liveBlock");
  const liveOutput = document.getElementById("liveOutput");

  const jobSummaryLine = document.getElementById("jobSummaryLine");
  const jobMode = document.getElementById("jobMode");
  const jobDryRun = document.getElementById("jobDryRun");
  const jobStarted = document.getElementById("jobStarted");
  const jobProgress = document.getElementById("jobProgress");
  const jobBook = document.getElementById("jobBook");
  const jobPath = document.getElementById("jobPath");

  let lastJobStatus = "none";

  function progressText(j) {
    const cur = (typeof j.current === "number") ? j.current : 0;
    const tot = (typeof j.total === "number") ? j.total : 0;

    if (tot > 0) return `${cur}/${tot}`;

    // tot == 0 ⇒ show friendly per-mode “nothing to do”
    const mode = (j.mode || "").toLowerCase();
    if (mode === "cleanup") return "Nothing to delete";
    if (mode === "correct") return "All names correct";
    if (mode === "convert") return "Nothing to convert";
    return "Nothing to do";
  }

  async function fetchJob() {
    const r = await fetch("/api/job", { cache: "no-store" });
    return await r.json();
  }

  async function fetchOutput() {
    const r = await fetch("/job/output", { cache: "no-store" });
    return await r.text();
  }

  async function poll() {
    try {
      const j = await fetchJob();

      if (!j || j.status === "none") {
        lastJobStatus = "none";
        clearJobBtn.disabled = true;

        jobSummaryLine.textContent = "Idle.";
        jobMode.textContent = "—";
        jobDryRun.textContent = "—";
        jobStarted.textContent = "—";
        jobProgress.textContent = "—";
        jobBook.textContent = "—";
        jobPath.textContent = "—";

        if (liveToggle.checked) {
          liveBlock.style.display = "block";
          liveOutput.textContent = "";
        } else {
          liveBlock.style.display = "none";
        }
        return;
      }

      lastJobStatus = j.status || "unknown";
      clearJobBtn.disabled = (lastJobStatus === "running");

      // Summary line
      if (lastJobStatus === "running") jobSummaryLine.textContent = "Running.";
      else if (lastJobStatus === "finished") jobSummaryLine.textContent = "Finished.";
      else if (lastJobStatus === "failed") jobSummaryLine.textContent = "Failed.";
      else jobSummaryLine.textContent = (lastJobStatus || "—");

      jobMode.textContent = j.mode || "—";
      jobDryRun.textContent = (j.dry_run === true) ? "true" : (j.dry_run === false ? "false" : "—");
      jobStarted.textContent = j.started || "—";
      jobProgress.textContent = progressText(j);

      jobBook.textContent = j.current_book ? `Book: ${j.current_book}` : "—";
      jobPath.textContent = j.current_path ? `Path: ${j.current_path}` : "—";

      // Live output
      if (liveToggle.checked) {
        liveBlock.style.display = "block";
        const out = await fetchOutput();
        liveOutput.textContent = out || "";
        liveOutput.scrollTop = liveOutput.scrollHeight;
      } else {
        liveBlock.style.display = "none";
      }

    } catch (e) {
      // ignore transient errors
    }
  }

  liveToggle.addEventListener("change", () => {
    liveBlock.style.display = liveToggle.checked ? "block" : "none";
  });

  poll();
  setInterval(poll, 2000);
</script>
{% endblock %}
