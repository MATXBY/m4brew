{% extends "base.html" %}
{% block title %}m4brew • Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}?v=0.9.9">
{% endblock %}

{% block content %}
<div class="card card--tasks">
  <div class="task-stack">

    <!-- STEP 1 -->
    <div class="task-row">
      <div class="task-group">
        <div class="step-label" aria-hidden="true"><span class="step-strong">STEP 1:</span>&nbsp;Convert to m4b</div>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn task-btn task-test" type="submit">Test</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="false">
          <button class="btn task-btn task-run run-1" type="submit">Run</button>
        </form>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="task-row">
      <div class="task-group">
        <div class="step-label" aria-hidden="true"><span class="step-strong">STEP 2:</span>&nbsp;Rename books</div>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn task-btn task-test" type="submit">Test</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="false">
          <button class="btn task-btn task-run run-2" type="submit">Run</button>
        </form>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="task-row">
      <div class="task-group">
        <div class="step-label" aria-hidden="true"><span class="step-strong">STEP 3:</span>&nbsp;Remove backups</div>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn task-btn task-test" type="submit">Test</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="false">
          <button class="btn task-btn task-run run-3" type="submit">Run</button>
        </form>
      </div>
    </div>

    <!-- STATUS -->
    <div class="status-wrap">
      <div class="status-top">
        <div class="status-pill" id="statusPill">Ready</div>

        <button class="btn" id="liveBtn" type="button">Live output: OFF</button>

        <!-- Cancel: hidden unless a convert job is running -->
        <form method="post" action="/job/cancel" id="cancelForm">
          <button class="btn danger" type="submit" id="cancelBtn" style="display:none;">Cancel</button>
        </form>
      </div>

      <div id="logWrap" style="display:none;">
        <pre id="logPre" class="mono"></pre>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const statusPill = document.getElementById("statusPill");
  const liveBtn = document.getElementById("liveBtn");
  const logWrap = document.getElementById("logWrap");
  const logPre  = document.getElementById("logPre");
  const cancelBtn = document.getElementById("cancelBtn");

  let liveOn = (localStorage.getItem("m4brew_live") === "1");

  function setLiveUI(){
    liveBtn.textContent = "Live output: " + (liveOn ? "ON" : "OFF");
    logWrap.style.display = liveOn ? "block" : "none";
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem("m4brew_live", liveOn ? "1" : "0");
    setLiveUI();
  });

  function statusTextForFinished(job){
    const s = (job && job.summary) ? job.summary : {};
    const mode = String(job && job.mode ? job.mode : "").toLowerCase();

    const noun = (mode === "convert") ? "convert"
               : (mode === "correct") ? "rename"
               : (mode === "cleanup") ? "delete"
               : "run";

    const past = (mode === "convert") ? "converted"
               : (mode === "correct") ? "renamed"
               : (mode === "cleanup") ? "deleted"
               : "done";

    const count = (mode === "convert") ? Number(s.created ?? 0)
                 : (mode === "correct") ? Number(s.renamed ?? 0)
                 : (mode === "cleanup") ? Number(s.deleted ?? 0)
                 : 0;

    const isDry =
      (s.dry_run === true) || (s.dry_run === "true") ||
      (job && (job.dry_run === true || job.dry_run === "true"));

    if(count > 0){
      if(isDry) return "Test: " + count + " to " + noun;
      return '<span style="color:#6ee7b7;font-weight:800;">✓&nbsp;</span>Done: ' + count + " " + past;
    }

    return "Nothing to " + noun;
  }


  async function tick(){
    try{
      const r = await fetch("/api/job", {cache:"no-store"});
      const job = await r.json();

      // Cancel button only visible while RUNNING a CONVERT job
      const showCancel = (job && job.status === "running" && job.mode === "convert");
      cancelBtn.style.display = showCancel ? "inline-flex" : "none";

      // Status pill text
      if(!job || !job.status){
        statusPill.textContent = "Ready";
      }else if(job.status === "running"){
        const mode = (job.mode || "").toLowerCase();
        if(job.total && job.total > 0){
          statusPill.textContent = `Running: ${job.current}/${job.total}`;
        }else{
          statusPill.textContent =
            mode === "convert" ? "Converting…" :
            mode === "correct" ? "Renaming…" :
            mode === "cleanup" ? "Deleting…" : "Running…";
        }
      }else if(job.status === "finished"){
        statusPill.innerHTML = statusTextForFinished(job);
      }else{
        statusPill.textContent = job.status;
      }

      // Live output
      if(liveOn){
        const out = await fetch("/job/output", {cache:"no-store"});
        const txt = await out.text();
        logPre.textContent = txt || "";
      }
    }catch(e){
      // keep UI calm if api hiccups
    }
  }

  setLiveUI();
  tick();
  setInterval(tick, 1200);
})();
</script>
{% endblock %}
