{% extends "base.html" %}
{% block title %}m4brew • Tasks{% endblock %}

{% block extra_head %}
<style>
  /* Tasks page layout: match Settings stacked rows */
  .stack {
    display: grid;
    gap: 14px;
    padding: 6px;
  }

  .task-row {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 14px;
    align-items: center;
    padding: 16px;
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
  }

  @media (max-width: 720px) {
    .task-row { grid-template-columns: 1fr; }
  }

  /* EXACT same look/feel as Settings left pills */
  .label-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 999px;
    font-weight: 650;
    letter-spacing: .2px;
    background: rgba(124,92,255,.18);
    border: 1px solid rgba(124,92,255,.32);
    color: rgba(233,237,243,.92);
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    white-space: nowrap;
  }

  .actions {
    display:flex;
    justify-content:flex-end;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* Output block */
  .output-head {
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .output-actions {
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap: wrap;
  }
  .toggle {
    display:inline-flex;
    align-items:center;
    gap: 8px;
    color: var(--text);
    user-select:none;
  }
  .toggle input { accent-color: var(--accent); }

  /* Make sure button text stays white everywhere */
  .btn { color: var(--text) !important; }
  .btn.primary { color: var(--text) !important; }
  .btn.danger { color: var(--text) !important; }
</style>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="stack">

      <!-- Step 1 -->
      <div class="task-row">
        <div class="label-pill">step 1: convert to m4b</div>
        <div class="actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="true">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn" type="submit">Test</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="convert">
            <input type="hidden" name="dry_run" value="false">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn primary" type="submit">Start</button>
          </form>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="task-row">
        <div class="label-pill">step 2: rename books</div>
        <div class="actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="true">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn" type="submit">Test</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="correct">
            <input type="hidden" name="dry_run" value="false">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn primary" type="submit">Start</button>
          </form>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="task-row">
        <div class="label-pill">step 3: remove backups</div>
        <div class="actions">
          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="true">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn" type="submit">Test</button>
          </form>

          <form method="post" action="/" style="margin:0;">
            <input type="hidden" name="mode" value="cleanup">
            <input type="hidden" name="dry_run" value="false">
            <input type="hidden" name="root_folder" value="{{ settings.get('root_folder','') if settings else '' }}">
            <input type="hidden" name="audio_mode" value="{{ settings.get('audio_mode','match') if settings else 'match' }}">
            <input type="hidden" name="bitrate" value="{{ settings.get('bitrate', 64) if settings else 64 }}">
            <button class="btn primary" type="submit">Start</button>
          </form>
        </div>
      </div>

    </div>
  </div>

  <!-- Output -->
  <div class="card" style="margin-top: 16px;">
    <div class="output-head">
      <div class="label-pill" style="background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); box-shadow:none;">
        output
      </div>

      <div class="output-actions">
        <label class="toggle">
          <input type="checkbox" id="liveToggle">
          Live output
        </label>

        <button class="btn danger" id="cancelBtn" type="button" disabled>Cancel</button>

        <form method="post" action="/job/clear" style="margin:0;">
          <button class="btn" id="clearBtn" type="submit" disabled>Clear</button>
        </form>
      </div>
    </div>

    <div class="muted mono" id="jobMeta" style="margin-bottom: 8px;">—</div>
    <div style="font-weight:650; margin-bottom: 10px;" id="jobProgressLine">Progress —</div>

    <pre id="jobOutput" style="display:none;"></pre>
    <div class="muted" id="jobStatusLine">—</div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const liveToggle = document.getElementById("liveToggle");
  const jobMeta = document.getElementById("jobMeta");
  const jobProgressLine = document.getElementById("jobProgressLine");
  const jobOutput = document.getElementById("jobOutput");
  const jobStatusLine = document.getElementById("jobStatusLine");
  const clearBtn = document.getElementById("clearBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  async function fetchJob() {
    try {
      const r = await fetch("/api/job", { cache: "no-store" });
      return await r.json();
    } catch {
      return null;
    }
  }

  async function fetchOutput() {
    try {
      const r = await fetch("/job/output", { cache: "no-store" });
      return await r.text();
    } catch {
      return "";
    }
  }

  function progressText(j) {
    const cur = (typeof j.current === "number") ? j.current : 0;
    const tot = (typeof j.total === "number") ? j.total : 0;

    if (!tot) {
      if (j.mode === "cleanup") return "Nothing to delete";
      if (j.mode === "correct") return "All names correct";
      return "Nothing to convert";
    }
    return `${cur}/${tot}`;
  }

  async function tick() {
    const j = await fetchJob();
    if (!j || j.status === "none") {
      jobMeta.textContent = "—";
      jobProgressLine.textContent = "Progress —";
      jobStatusLine.textContent = "—";
      clearBtn.disabled = true;
      cancelBtn.disabled = true;
      if (liveToggle.checked) jobOutput.style.display = "block";
      if (liveToggle.checked) jobOutput.textContent = "";
      return;
    }

    const mode = j.mode || "—";
    const dry = (j.dry_run === true) ? "true" : (j.dry_run === false ? "false" : "—");
    const started = j.started || "—";
    jobMeta.textContent = `mode: ${mode} · dry_run: ${dry} · started: ${started}`;

    jobProgressLine.textContent = `Progress ${progressText(j)}`;

    const status = j.status || "—";
    jobStatusLine.textContent = (status === "running") ? "Running…" : "Finished.";

    // Cancel not wired yet (keep disabled)
    cancelBtn.disabled = true;

    // Clear only when not running
    clearBtn.disabled = (status === "running");

    if (liveToggle.checked) {
      jobOutput.style.display = "block";
      jobOutput.textContent = await fetchOutput();
    } else {
      jobOutput.style.display = "none";
    }
  }

  tick();
  setInterval(tick, 2000);
</script>
{% endblock %}
