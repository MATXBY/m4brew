{% extends "base.html" %}

{% block title %}m4brew • Tasks{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block content %}
<div class="card card--tasks">
  <div class="task-stack">

    <!-- Step 1 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="convert">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 1: convert to m4b
          </button>
        </form>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="correct">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 2: rename books
          </button>
        </form>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="task-row">
      <div class="task-group">
        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="true">
          <button class="btn" type="submit">Test run</button>
        </form>

        <form method="post" action="/">
          <input type="hidden" name="mode" value="cleanup">
          <input type="hidden" name="dry_run" value="false">
          <button class="step-pill step-btn" type="submit">
            step 3: remove backups
          </button>
        </form>
      </div>
    </div>

    <!-- Status -->
    <div class="status-wrap">
      <div class="status-top">

        <div id="statusPill" class="status-pill">
          <span id="statusDot" class="status-dot dot-idle"></span>
          <span id="statusText">idle</span>
        </div>

        <!-- Cancel lives here, but is HIDDEN unless convert is running/canceling -->
        <form method="post" action="/job/cancel" id="cancelForm" style="display:none;">
          <button class="btn danger" type="submit" id="cancelBtn">Cancel</button>
        </form>

        <button id="liveBtn" class="btn" type="button">
          Live output: OFF
        </button>
      </div>

      <div id="logWrap" style="display:none;">
        <pre id="logBox" class="mono"></pre>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const logWrap = document.getElementById("logWrap");
  const logBox = document.getElementById("logBox");
  const liveBtn = document.getElementById("liveBtn");

  const cancelForm = document.getElementById("cancelForm");
  const cancelBtn = document.getElementById("cancelBtn");

  const LIVE_KEY = "m4brew_live_output";
  let liveOn = (localStorage.getItem(LIVE_KEY) || "off") === "on";

  function setLiveLabel(){
    liveBtn.textContent = liveOn ? "Live output: ON" : "Live output: OFF";
  }

  function applyLive(){
    if (liveOn) {
      logWrap.style.display = "";
      liveBtn.classList.add("primary");
    } else {
      logWrap.style.display = "none";
      liveBtn.classList.remove("primary");
    }
    setLiveLabel();
  }

  liveBtn.addEventListener("click", () => {
    liveOn = !liveOn;
    localStorage.setItem(LIVE_KEY, liveOn ? "on" : "off");
    applyLive();
  });

  function setDot(cls){
    statusDot.className = "status-dot " + cls;
  }

  function modeWord(mode){
    mode = String(mode || "").toLowerCase();
    if (mode === "convert") return "convert";
    if (mode === "correct") return "rename";
    if (mode === "cleanup") return "delete";
    return "run";
  }

  function friendlyStatus(job){
    const status = String(job.status || "idle").toLowerCase();
    const mode = modeWord(job.mode);
    const total = Number(job.total || 0);
    const current = Number(job.current || 0);

    if (status === "running" || status === "canceling") {
      if (total > 0) return `${current}/${total} ${mode}`;
      return `${mode}…`;
    }

    if ((job.mode || "").length) {
      if (total <= 0) return `nothing to ${mode}`;
      return `${total} to ${mode}`;
    }

    return status;
  }

  function updateCancelVisibility(job){
    const status = String(job.status || "").toLowerCase();
    const mode = String(job.mode || "").toLowerCase();

    const isConvert = (mode === "convert");
    const isRunning = (status === "running" || status === "canceling");

    // Only show Cancel when CONVERT is running/canceling
    if (isConvert && isRunning) {
      cancelForm.style.display = "inline";
      cancelBtn.disabled = false;
    } else {
      cancelForm.style.display = "none";
      cancelBtn.disabled = true;
    }
  }

  async function tick(){
    try {
      const r = await fetch("/api/job", { cache: "no-store" });
      const job = await r.json();

      const status = String(job.status || "idle").toLowerCase();
      statusText.textContent = friendlyStatus(job);

      updateCancelVisibility(job);

      if (status === "running") setDot("dot-run");
      else if (status === "canceling") setDot("dot-warn");
      else if (status === "finished") setDot("dot-ok");
      else if (status === "failed") setDot("dot-bad");
      else if (status === "canceled") setDot("dot-warn");
      else setDot("dot-idle");

      if (liveOn) {
        const t = await fetch("/job/output", { cache: "no-store" });
        const text = await t.text();
        logBox.textContent = text || "";
      }
    } catch (e) {}
  }

  applyLive();
  tick();
  setInterval(tick, 1000);
</script>
{% endblock %}
